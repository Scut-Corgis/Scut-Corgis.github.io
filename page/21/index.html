<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/corgis.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/corgis.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"scut-corgis.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="用于成长过程中，记录值得对外分享的技术，如开源代码理解、国外课程项目，个人对一些领域的心得等">
<meta property="og:type" content="website">
<meta property="og:title" content="corgis的笔记">
<meta property="og:url" content="https://scut-corgis.github.io/page/21/index.html">
<meta property="og:site_name" content="corgis的笔记">
<meta property="og:description" content="用于成长过程中，记录值得对外分享的技术，如开源代码理解、国外课程项目，个人对一些领域的心得等">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Corgis">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://scut-corgis.github.io/page/21/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/21/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>corgis的笔记</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">corgis的笔记</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Corgis"
      src="/images/corgis.jpg">
  <p class="site-author-name" itemprop="name">Corgis</p>
  <div class="site-description" itemprop="description">用于成长过程中，记录值得对外分享的技术，如开源代码理解、国外课程项目，个人对一些领域的心得等</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://scut-corgis.github.io/2024-10-20-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/corgis.jpg">
      <meta itemprop="name" content="Corgis">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="corgis的笔记">
      <meta itemprop="description" content="用于成长过程中，记录值得对外分享的技术，如开源代码理解、国外课程项目，个人对一些领域的心得等">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | corgis的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024-10-20-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E7%AB%AF/" class="post-title-link" itemprop="url">数据库管控平台设计与实现-服务端</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-20 21:10:05" itemprop="dateCreated datePublished" datetime="2024-10-20T21:10:05+08:00">2024-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">数据库管控</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>各大公司都有庞大的数据库资源，涉及机器轻则上千，基本都是以万计。几乎每天都有机器宕机，或者发生网络延迟，或者发生机房故障。稍有不慎便容易出现管控缺失，数据库不稳定的问题。而数据库稳定性一般都是最重要的一环。</p>
<p>一般数据库管控维度为分数据库种类，再细分对应的业务集群。如何设计一个数据库管控系统，其具备一些公共能力，能够对各种数据库集群进行相应的具体的管控逻辑的开发，具有一定的挑战。</p>
<p>首先，当前业界通用的做法是如下图所示，通过在数据库机器中内嵌相应的agent进程，该agent负责管理当前机器上的数据库进程，上报与采集内核信息，以实现相应的管控逻辑。</p>
<p><img src="/2024-10-20-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E7%AB%AF/mgr-agent%E6%9E%B6%E6%9E%84.drawio.svg"></p>
<p>当然一个好的平台不仅需要强大的后端组件支持，还需要前端项目用于展示和运维人员操作的，在本文中着重讨论后端部分。</p>
<h1 id="运维模块"><a href="#运维模块" class="headerlink" title="运维模块"></a>运维模块</h1><h2 id="插件系统"><a href="#插件系统" class="headerlink" title="插件系统"></a>插件系统</h2><p>一些数据库，对应运维操作相当复杂，即运维管控代码庞大。若以脚本语言如python完全去写起管控逻辑，到后期几乎无法维护，因此管控平台需要能够提供原生语言的编写能力，一般管控平台以golang编写，则应当允许数据库运维开发方能够直接使用golang编写运维逻辑。</p>
<p>一种实现方法是，提供某种代码生成器，将业务golang的接口代码直接生成与管控平台黏合的代码，并编译成<code>.so</code>文件，供动态链接，这种方法的好处是，一个mgr可以链接多个插件系统，即服务多种数据库。</p>
<h2 id="任务执行"><a href="#任务执行" class="headerlink" title="任务执行"></a>任务执行</h2><p>负责任务的创建、管理、下发、agent回复处理等工作</p>
<p>该模块是数据库管控平台最重要的模块。每一个管控逻辑，都是由一个或多个任务组成。而强大的管控平台可以提供多种任务编写方式，如shell、python、甚至是直接的golang语言。</p>
<p>任务必须具备可取消的能力，即超时关闭，若直接在线程中运行任务显然无法取消。一种简单的方式是，执行任务的线程，再起一个任务线程并记录pid，并不断观测任务线程结果，必要时直接杀死对应线程。</p>
<p>任务必须具备提取返回值的能力，这对于golang来说实现简单，因为管控平台原生语言即为golang。而对于python而言捕获返回值相当困难。一种可行的实现是python返回结果直接json化后写到某个临时文件，供golang代码后续读并解码(python任务日志也可以如此实现)。</p>
<p>对于shell执行器，为了记录中间的<code>echo xxx</code>输出，需要捕获相应的stdout并于日志文件中。需要关心shell脚本的退出码以判断任务的成功与否。</p>
<p>对于python执行器，python执行器应该能够只执行某个<code>.py</code>文件的某个类中的一个成员函数。一种实现是可以用shell执行器作为中间方，以shell执行器启动<code>python_control.sh args</code>，将任务入参放在<code>args</code>，在里面执行<code>python control.py options=args</code>，再以<code>control.py</code>去调用相应具体python任务。</p>
<p>为了持续的观测任务的执行过程，供前端展示任务的执行情况，任务创建时应该往管控数据库中插入任务信息和状态信息，任务执行完后需要修改对应任务的状态。</p>
<p>任务执行需要区别mgr本地执行与agent远端执行，对于agent远端执行，需要区分同步与异步两种方式。实际两种方法本质一样，均向agent调用执行任务接口，agent执行完后会调用mgr的上报接口。同步的话，mgr要hold住请求不返回即可，直到agent回复。</p>
<h2 id="定时调度"><a href="#定时调度" class="headerlink" title="定时调度"></a>定时调度</h2><p>定时调度在数据库管控中相当常见，比如机器宕机检测与恢复。我们可以很方便的在任务执行模块上实现定时调度。</p>
<p>只需要将定时调度信息存于管控数据库中。使用某种<code>cron</code>包进行调度即可。</p>
<h2 id="流程引擎"><a href="#流程引擎" class="headerlink" title="流程引擎"></a>流程引擎</h2><p>有的运维操作相当冗长，如数据中心级别的故障转移。若以代码硬编码将无法维护，一般是以编写多个任务以类似流水线的方式串接起来，应该管控平台需要具备流程引擎的能力。</p>
<p>一般实现是，前端画流程图，并将对应流程图结构化插入到管控数据库中，后端mgr只需要取出管控数据库中已经结构化的流程定义即可。</p>
<p>使用方式：前端画流程图，生成流程定义到数据库中。后端从数据库中取流程定义，然后执行流程，将执行结果记录到数据库中。</p>
<h3 id="前端实现"><a href="#前端实现" class="headerlink" title="前端实现"></a>前端实现</h3><p><img src="/2024-10-20-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%95%8C%E9%9D%A2.png"></p>
<h3 id="后端实现"><a href="#后端实现" class="headerlink" title="后端实现"></a>后端实现</h3><h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><h5 id="process"><a href="#process" class="headerlink" title="process"></a>process</h5><p>当前端编辑完，保存后，会将流程的数据结构放于mongo表<code>process</code>中</p>
<p><img src="/2024-10-20-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E7%AB%AF/process.png"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Process 流程</span></span><br><span class="line"><span class="keyword">type</span> Process <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 基础信息</span></span><br><span class="line">    Name   <span class="type">string</span> <span class="string">`json:&quot;name&quot; bson:&quot;name&quot;`</span>       <span class="comment">// 流程名</span></span><br><span class="line">    ChName <span class="type">string</span> <span class="string">`json:&quot;ch_name&quot; bson:&quot;ch_name&quot;`</span> <span class="comment">// 流程中文名</span></span><br><span class="line">    <span class="comment">// 属性信息</span></span><br><span class="line">    ParamList      []ValueDefinition <span class="string">`json:&quot;param_list&quot; bson:&quot;param_list&quot;`</span>           <span class="comment">// 全局入参</span></span><br><span class="line">    ResultList     []ValueDefinition <span class="string">`json:&quot;result_list&quot; bson:&quot;result_list&quot;`</span>         <span class="comment">// 全局结果</span></span><br><span class="line">    <span class="comment">// 节点信息，记录了流程图一个节点的全部信息，如task，其入参信息等等</span></span><br><span class="line">    ActivityList   []Activity        <span class="string">`json:&quot;activity_list&quot; bson:&quot;activity_list&quot;`</span>    </span><br><span class="line">    SequenceList   []Sequence        <span class="string">`json:&quot;sequence_list&quot; bson:&quot;sequence_list&quot;`</span>     <span class="comment">// activity连线列表</span></span><br><span class="line">    Author         <span class="type">string</span>            <span class="string">`json:&quot;author&quot; bson:&quot;author&quot;`</span>                   <span class="comment">// 创建人</span></span><br><span class="line">    CreatedAt      <span class="type">int64</span>             <span class="string">`json:&quot;created_at&quot; bson:&quot;created_at&quot;`</span>           <span class="comment">// 创建时间</span></span><br><span class="line">    UpdatedAt      <span class="type">int64</span>             <span class="string">`json:&quot;updated_at&quot; bson:&quot;updated_at&quot;`</span>           <span class="comment">// 更新时间</span></span><br><span class="line">    Position       <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;position&quot; bson:&quot;position&quot;`</span>               <span class="comment">// activity的位置信息，&#123;node_1: &quot;top:xx;left:xx&quot;&#125;</span></span><br><span class="line">    ConnectionDire <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;connection_dire&quot; bson:&quot;connection_dire&quot;`</span> <span class="comment">// 连线的方向信息,&#123;node_1-node_2: &quot;rig-left&quot;&#125;</span></span><br><span class="line">    Labels         []ValueDefinition <span class="string">`json:&quot;labels&quot; json:&quot;labels&quot;`</span>                   <span class="comment">// 流程拥有标签</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024-10-20-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E7%AB%AF/activity_list.png"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Activity 活动节点的定义</span></span><br><span class="line"><span class="keyword">type</span> Activity <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 基础信息</span></span><br><span class="line">    Name   <span class="type">string</span>       <span class="string">`json:&quot;name&quot; bson:&quot;name&quot;`</span>       <span class="comment">// 名称，自动生成</span></span><br><span class="line">    ChName <span class="type">string</span>       <span class="string">`json:&quot;ch_name&quot; bson:&quot;ch_name&quot;`</span> <span class="comment">// 中文名称，选填，为空时按如下顺序赋值：任务/process</span></span><br><span class="line">    Type   ActivityType <span class="string">`json:&quot;type&quot; bson:&quot;type&quot;`</span>       <span class="comment">// 类型，对应ActivityType。比如为task或者start</span></span><br><span class="line">    <span class="comment">// 属性信息</span></span><br><span class="line">    ParamList    []ValueDefinition <span class="string">`json:&quot;param_list&quot; bson:&quot;param_list&quot;`</span>       <span class="comment">// 节点入参</span></span><br><span class="line">    ResultList   []ValueDefinition <span class="string">`json:&quot;result_list&quot; bson:&quot;result_list&quot;`</span>     <span class="comment">// 输出结果</span></span><br><span class="line">    InputAnchor  <span class="type">string</span>            <span class="string">`json:&quot;input_anchor&quot; bson:&quot;input_anchor&quot;`</span>   <span class="comment">// 入参锚点</span></span><br><span class="line">    OutputAnchor <span class="type">string</span>            <span class="string">`json:&quot;output_anchor&quot; bson:&quot;output_anchor&quot;`</span> <span class="comment">// 出参锚点</span></span><br><span class="line">    Timeout      <span class="type">int64</span>             <span class="string">`json:&quot;timeout&quot; bson:&quot;timeout&quot;`</span>             <span class="comment">// 超时时间，单位秒</span></span><br><span class="line">    LoopUntil    <span class="type">string</span>            <span class="string">`json:&quot;loop_until&quot; bson:&quot;loop_until&quot;`</span>       <span class="comment">// 循环等待</span></span><br><span class="line">    LoopInterval <span class="type">int64</span>             <span class="string">`json:&quot;loop_interval&quot; bson:&quot;loop_interval&quot;`</span> <span class="comment">// 循环间隔，单位秒</span></span><br><span class="line">    SuccFlag     <span class="type">string</span>            <span class="string">`json:&quot;succ_flag&quot; bson:&quot;succ_flag&quot;`</span>         <span class="comment">// 任务执行成功与否的标识</span></span><br><span class="line">    <span class="comment">// 内容</span></span><br><span class="line">    Content <span class="type">string</span> <span class="string">`json:&quot;content&quot; bson:&quot;content&quot;`</span> <span class="comment">// 包含的任务或流程</span></span><br><span class="line">    Remote  <span class="type">bool</span>   <span class="string">`json:&quot;remote&quot; bson:&quot;remote&quot;`</span>   <span class="comment">// 针对作业平台任务，标识是否远程任务，默认false，如果为true，则入参默认增加target_hosts, 出参增加succ_hosts</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024-10-20-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E7%AB%AF/seq_list.png"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Sequence <span class="keyword">struct</span> &#123;</span><br><span class="line">    Source    <span class="type">string</span> <span class="string">`json:&quot;source&quot; bson:&quot;source&quot;`</span>       <span class="comment">// 源activity name</span></span><br><span class="line">    Target    <span class="type">string</span> <span class="string">`json:&quot;target&quot; bson:&quot;target&quot;`</span>       <span class="comment">// 目标activity name</span></span><br><span class="line">    Condition <span class="type">string</span> <span class="string">`json:&quot;condition&quot; bson:&quot;condition&quot;`</span> <span class="comment">// 条件表达式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ProcessInstance"><a href="#ProcessInstance" class="headerlink" title="ProcessInstance"></a>ProcessInstance</h5><p>开始运行流程时，会根据全局传参和默认参数，合成一个最终流程全局入参，创建一个<code>processInstance</code>对象，并将该对象插入mongo中<code>process_instance</code>表内</p>
<p><img src="/2024-10-20-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E7%AB%AF/process_instance.png"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ProcessInstance 流程实例</span></span><br><span class="line"><span class="keyword">type</span> ProcessInstance <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID                 <span class="type">string</span>                 <span class="string">`json:&quot;id&quot; bson:&quot;_id&quot;`</span>                                      <span class="comment">// 流程实例ID</span></span><br><span class="line">    ParentID           <span class="type">string</span>                 <span class="string">`json:&quot;parent_id&quot; bson:&quot;parent_id&quot;`</span>                         <span class="comment">// 父流程实例ID</span></span><br><span class="line">    Name               <span class="type">string</span>                 <span class="string">`json:&quot;name&quot; bson:&quot;name&quot;`</span>                                   <span class="comment">// 流程名</span></span><br><span class="line">    Params             <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;params&quot; bson:&quot;params&quot;`</span>                               <span class="comment">// 流程的入参</span></span><br><span class="line">    Result             <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;result&quot; bson:&quot;result&quot;`</span>                               <span class="comment">// 流程从执行结果</span></span><br><span class="line">    Status             Status                 <span class="string">`json:&quot;status&quot; bson:&quot;status&quot;`</span>                               <span class="comment">// 状态</span></span><br><span class="line">    RunStack           []<span class="type">string</span>               <span class="string">`json:&quot;run_stack&quot; bson:&quot;run_stack&quot;`</span>                         <span class="comment">// 执行栈</span></span><br><span class="line">    RunIndex           <span class="type">int</span>                    <span class="string">`json:&quot;run_index&quot; bson:&quot;run_index&quot;`</span>                         <span class="comment">// 指向执行栈的索引，从0开始，譬如停留在3，表明0、1、2已经顺利执行，3未执行或未彻底完成</span></span><br><span class="line">    Runner             <span class="type">string</span>                 <span class="string">`json:&quot;runner&quot; bson:&quot;runner&quot;`</span>                               <span class="comment">// 执行人</span></span><br><span class="line">    CreatedAt          <span class="type">int64</span>                  <span class="string">`json:&quot;created_at&quot; bson:&quot;created_at&quot;`</span>                       <span class="comment">// 创建时间</span></span><br><span class="line">    UpdatedAt          <span class="type">int64</span>                  <span class="string">`json:&quot;updated_at&quot; bson:&quot;updated_at&quot;`</span>                       <span class="comment">// 更新时间</span></span><br><span class="line">    Labels             <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;labels&quot; bson:&quot;labels&quot;`</span>                               <span class="comment">// 流程实例标签</span></span><br><span class="line">    Audit              <span class="type">bool</span>                   <span class="string">`json:&quot;audit&quot; bson:&quot;audit&quot;`</span>                                 <span class="comment">// 是否审计</span></span><br><span class="line">    StartEventStack    []<span class="type">string</span>               <span class="string">`json:&quot;start_event_stack&quot; bson:&quot;start_event_stack&quot;`</span>         <span class="comment">// 开始执行事件堆栈</span></span><br><span class="line">    StartEventRunIndex <span class="type">int</span>                    <span class="string">`json:&quot;start_event_run_index&quot; bson:&quot;start_event_run_index&quot;`</span> <span class="comment">// 开始事件执行栈的索引</span></span><br><span class="line">    ExitEventStack     []<span class="type">string</span>               <span class="string">`json:&quot;exit_event_stack&quot; bson:&quot;exit_event_stack&quot;`</span>           <span class="comment">// 退出事件执行栈</span></span><br><span class="line">    ExitEventRunIndex  <span class="type">int</span>                    <span class="string">`json:&quot;exit_event_run_index&quot; bson:&quot;exit_event_run_index&quot;`</span>   <span class="comment">// 退出执行栈索引</span></span><br><span class="line">    Event              <span class="type">bool</span>                   <span class="string">`json:&quot;event&quot; bson:&quot;event&quot;`</span>                                 <span class="comment">// 是否触发事件的开关</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="基础模块"><a href="#基础模块" class="headerlink" title="基础模块"></a>基础模块</h1><h2 id="选主与切换"><a href="#选主与切换" class="headerlink" title="选主与切换"></a>选主与切换</h2><p>manager作为管控中心，本身存在leader与follower，leader会遇到宕机的风险，有时也需要主动切主从使得leader部署到某个机房。因此必须具备选主的能力。</p>
<p>为了实现manager某种程度的无状态，一般将集群信息与主从信息记录到外部分布式数据库中。agent可直接查询数据库获得通信的主manager。</p>
<p>一般agent只需要与主mgr进行交流，若存在主mgr性能瓶颈，大多是因为数据库运维设置的定时调度运行过于频繁，经测试，一台manager管理数千台agent是没有压力的。</p>
<h2 id="自身版本升级"><a href="#自身版本升级" class="headerlink" title="自身版本升级"></a>自身版本升级</h2><p>在数据库管控中，升级操作一般就是下掉原来的进程，上一个新的进程。对于mgr同样可以如此做，而对于agent，甚至只需要重启即可，当然重启前并不是直接杀死再启动进程，需要设计一种信号机制，让agent捕获该信号，在处理完当前任务后，平滑退出。如使用go的context管理上下文协程。</p>
<blockquote>
<p>在实际实现中，这里的设计较为复杂。</p>
</blockquote>
<h2 id="机器资源监控"><a href="#机器资源监控" class="headerlink" title="机器资源监控"></a>机器资源监控</h2><p>agent组件实现机器资源的定期探测和上报是必不可少的。这对后续部署数据库节点的判断具有决定性的意义，也能够给前端直接展示相应的资源使用会存量，以供运维人员或自动化运维工具判断。</p>
<h2 id="日志模块"><a href="#日志模块" class="headerlink" title="日志模块"></a>日志模块</h2><p>需要设计与选型好日志组件，因为管控过程中有相当多不同的逻辑流，如执行任务，执行流程，定时调度，具体的数据库管控插件日志，为了方便后续定位位置，需要对不同的逻辑流写不同的滚动日志文件。</p>
<h1 id="外部管理模块"><a href="#外部管理模块" class="headerlink" title="外部管理模块"></a>外部管理模块</h1><h2 id="文件管理"><a href="#文件管理" class="headerlink" title="文件管理"></a>文件管理</h2><p>为了方便管理，我们可让具体的数据库管控脚本在mgr和agent同步，这种好处在于我们写了一个新的管控脚本，只需要下发给对应的mgr，便可以直接使用，无需在手动分发给各个agent。</p>
<p>这个模块实现文件夹同步，需要定期检测同步文件夹，具备压缩能力，具备md5计算能力防止重复发送。一般具体数据库管控版本不升级，这里只会调用发送md5检查的接口。</p>
<blockquote>
<p>文件下发底层具体实现，直接用gin或者http即可</p>
</blockquote>
<h2 id="配置下发"><a href="#配置下发" class="headerlink" title="配置下发"></a>配置下发</h2><p>数据库节点部署，配置文件的管理与下发是难点之一，一般是将当前集群的多版本配置文件存在管控数据库中，供前端展示和编写。前端负责管理相应的模版，和特异化的参数，负责渲染拼接，再存于数据库中，记录对应配置版本。mgr需要提供相应的接口将对应的配置文件下发到agent指定位置，供相应进程启动使用。</p>
<p>其与文件管理不同的点在于，配置是mgr从数据库中拉下来下发给agent的，不经过磁盘。</p>
<h1 id="公共功能"><a href="#公共功能" class="headerlink" title="公共功能"></a>公共功能</h1><h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>在写数据库运维逻辑时，必定面对多运维操作并发的风险，如同时发起了对一个集群做扩容和缩容的流程，这种长时间运行的较重量级的流程不会允许并行。因此需要在Manager实现分布式锁，该锁需要考虑容量，因为有的操作是允许同时进行多个，如节点部署。</p>
<p>该锁的实现一种简单的方法是，将锁与其过期信息存于分布式数据库中（mongodb等，mysql主从强一致），加锁时检查数据库即可。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/20/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/22/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Corgis</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
